---
slideinit: "<section markdown=\"1\" data-background=\"../../../../../img/slidebackground.png\"><section markdown=\"1\">"
vertical: "</section><section markdown=\"1\">"
horizontal: "</section></section><section markdown=\"1\" data-background=\"../../../../../img/slidebackground.png\"><section markdown=\"1\">"
layout: post
title: QE实践详解
author: yyyu200
tags: DFT 原创
subtitle: ""
category: Blogs
notebookfilename: intro
visualworkflow: true
published: true
theme: beige
trans: cube
---


* TOC
{:toc}

# QE实践详解

## 1. 计算半导体SiC的能带

计算分为三个步骤：1. 优化晶格常数；2. 自洽计算；3. 能带计算。

### 1.1 设置结构参数

碳化硅SiC有多种结构，这里选择了比较简单的闪锌矿(Zincblende)结构。下面介绍结构信息的获取，已经了解可以直接阅读1.2节，闪锌矿结构的空间群是$F \overline{4}3M$（No. 216），布拉伐格子是面心立方（Face centered cubic）。计算需要知道SiC的原胞尺寸、原子坐标和晶格常数，这些参数是从实验得到的，除了从文献获取外，这里推荐一个数据库[Crystallography Open Database](http://www.crystallography.net/cod/)（COD，如果你手头有更好的cif数据库也可以）。打开COD主页，点击左侧的“search”。

<p align="center">
    <img src="../../../../../img/COD_send_search.png" width="300" />
</p>

在搜索页面“1 to 8 elements”一栏输入Si和C，“number of distinct elements min and max”一栏输入2和2，表示搜索Si和C元素组成的二元化合物，点击“send”开始搜索。搜索的结果包含了数据库中的SiC二元化合物的多种组分及结构，其中有两个空间群为F-43m是我们要找的闪锌矿结构，晶格常数略有不同，分别是4.348和4.358，选择可信度高的的一个，考虑到后面要计算晶格常数的理论值，这里的两个选择差别不大没有什么影响。

<p align="center">
    <img src="../../../../../img/COD_search_results.png" width="600" />
</p>

点击[CIF](http://www.crystallography.net/cod/1010995.cif)下载后缀为cif的文件。用[VESTA](http://www.jp-minerals.org/vesta/en/download.html)打开，（或使用其他可视化程序，如Material Studio等）。在VESTA中，点击“File”——“Export Data”，选择VASP的POSCAR格式，将文件保存为“SiC.vasp”文件。

```
Si C
1.0
        4.3480000496         0.0000000000         0.0000000000
        0.0000000000         4.3480000496         0.0000000000
        0.0000000000         0.0000000000         4.3480000496
   Si    C
    4    4
Direct
     0.000000000         0.000000000         0.000000000
     0.000000000         0.500000000         0.500000000
     0.500000000         0.000000000         0.500000000
     0.500000000         0.500000000         0.000000000
     0.250000000         0.250000000         0.250000000
     0.750000000         0.750000000         0.250000000
     0.750000000         0.250000000         0.750000000
     0.250000000         0.750000000         0.750000000

```
上面是得到的文件（SiC.vasp），包括了cell尺寸（以Å为单位，第3-5行）和原子坐标（分数坐标，第9-16行）。需要注意的是，导入cif文件得到是晶胞，有可能不是原胞，为了转化为原胞，最简单的方法是借助Material Studio的建模功能，也可以参考[这里表格2](../../07/TransCell/#tab2)，得到从晶胞到原胞的转换矩阵，输入VESTA中得到原胞，再用VESTA输出POSCAR格式。在VESTA中点击“Edit”——“Edit Data”——“Unit Cell”——“Transform”，输入转换矩阵如下图。

<p align="center">
    <img src="../../../../../img/transform.png" />
</p>


得到的结构文件如下，我们需要将其改成pw.x输入格式，见[INPUT_PW](https://www.quantum-espresso.org/Doc/INPUT_PW.html)。
```
Si C
1.0
        3.0745003223         0.0000000000         0.0000000000
        1.5372501612         2.6625953831         0.0000000000
        1.5372501612         0.8875317944         2.5103190013
   Si    C
    1    1
Direct
     0.000000000         0.000000000         0.000000000
     0.250000000         0.250000000         0.250000000
```

可以发现VESTA对CELL做了处理变成了一个下三角阵，但是这样不太容易找对称性（实际上pw.x确实没找全！），用[这里](https://github.com/yyyu200/SlabMaker)的脚本transcell.py，读入sc.vasp，运行python transcell.py，输出fcc.vasp，脚本导入了CELL.py。采用了[表格2](../../07/TransCell/#tab2)所述方法，可以实现所有类型（14种布拉伐格子中7种非简单格子，以及六方转菱方）的晶胞转原胞的功能，要求输入晶胞的POSCAR，并指定ibrav类型。结果如下：

```
system: Si C
1.0
 0.000000 2.174000 2.174000
 2.174000 0.000000 2.174000
 2.174000 2.174000 0.000000
Si C 
1 1 
Direct
 0.000000000000 0.000000000000 0.000000000000
 0.250000000000 0.250000000000 0.250000000000
```


将晶胞转化成原胞还可参考[[1]](https://avogadro.cc/docs/building-materials/reducing-crystals-to-primitive-cells/)，[[2]](https://www.researchgate.net/post/How_to_convert_a_conventional_cell_to_a_primitive_cell)中的phononpy，[[3]](http://www.cryst.ehu.es/cryst/celltran.html)，以及Material Studio的CASTEP计算前检查原胞的功能。

计算一种材料的步骤总结起来就是：cif文件——晶胞POSCAR——原胞POSCAR——pw.x输入。还是很曲折的，但是优点是可以VESTA画图，画图对于检查结构的正确性是有必要的，其实有经验的用户如果知道ibrav,celldm这些参数直接建原胞也是完全可行的而且是更推荐使用的，以上是对初学者或者比较陌生的结构，不失为一种通用方法。

pw.x 输入与结构有关的包括SYSTEM部分的
```
ibrav,celldm,nat,ntyp
```

以及ATOMIC_POSITIONS和CELL_PARAMETERS两部分。设置ibrav和celldm(1-6)指定CELL，这时不写CELL_PARAMETERS。或设置ibrav=0和CELL_PARAMETERS (angstrom)，这时不允许写出celldm(1)，程序会自动内部设置celldm(1) = alat = sqrt(v1*v1)，这里celldm代表晶格常数，单位是Bohr，方便转格式用VESTA画图。（CELL_PARAMETERS(alat)是需要写celldm(1)的作为alat的值）。在结构驰豫过程中，ATOMIC_POSITIONS是根据力而变化的，如果是vc-relax，原子坐标改变的同时，CELL_PARAMETERS根据应力变化（celldm在vc-relax时是不变的）。

我们通过cif文件的空间群（见[ITC](https://it.iucr.org/A/)，或通过文献），知道了SiC的布拉伐格子是面心立方，也可以设置ibrav=2，这时不需要转化为原胞，程序内部会将CELL_PARAMETERS设置为原胞，设置`celldm(1)=8.216529225786777`，即为Bohr为单位晶胞的基矢长度（4.348/0.52917720859），不写CELL_PARAMETERS。注意celldm(1)对于菱方以外是晶胞第一个基矢长度，对于菱方ibrav=5，celldm(1)是原胞基矢长度。

注：自6.4.1版本，[官方](https://gitlab.com/QEF/q-e/wikis/Releases/Quantum-Espresso-6.4.1-Release-Notes)不推荐celldm(1)=1.88972613（任何<2的值）的做法，>这里也修正为celldm(1)设置为晶格常数，或用ibrav$\neq$0。

### 1.2 结构弛豫的输入文件

pw.x处理的计算包括以下7种类型，在输入文件中用`calculation`设置：

'scf'：自洽计算，self-consistent field，通过迭代的方式数值求解微分-积分方程（Kohn-Sham方程），迭代收敛以电荷的变化足够小为准，最终得到自洽电荷。

'nscf'：非自洽计算，scf计算常在k空间的网格上进行，网格要足够密以完成k空间上的积分，在DOS等计算需要更密的k点，这时在自洽电荷基础上，计算这些更多的k点，nscf计算保持自洽电荷不变。

'bands'：也是一种nscf计算，k点按照三维k空间中的特殊路径选取。

'relax'：一系列scf计算，通过Hellman-Feynman力计算离子坐标驰豫（通过优化算法找到受力为零的结构），relax计算时固定cell不变。

'vc-relax': 允许cell变化的relax，通过应力的计算改变cell。

'md'：分子动力学，将电子对离子的作用看成离子感受到的势，跟据势能和离子初始速度求解离子运动的牛顿方程。

'vc-md'：允许cell改变的md。

pw.x的输入说明见[INPUT_PW](https://www.quantum-espresso.org/Doc/INPUT_PW.html)。注意默认的单位，其中原子单位制为（以下数值见源程序q-e-qe-6.3/Modules/constants.f90）：

```
1 bohr = 1 a.u. (atomic unit) = 0.52917720859 angstroms.
1 Rydberg (Ry) = 13.60569193 eV
```

pw.x的初始晶体结构及晶格参数通常是实验值。但是，为了后续的计算可能需要通过力的弛豫（relax）得到晶格参数的理论值（如果只计算体材料能带，而所关心的问题只限于电子性质而无关晶格，使用实验值也是可以的）。

结构弛豫的输入文件如下：

```
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    nat= 2, ntyp= 2,
    occupations = 'smearing', smearing = 'gauss', degauss = 1.0d-9
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Si 28.08550 Si.UPF
  C  12.01070 C.UPF
CELL_PARAMETERS (angstrom)
   2.174000000   2.174000000   0.000000000
   0.000000000   2.174000000   2.174000000
   2.174000000   0.000000000   2.174000000
ATOMIC_POSITIONS (crystal)
Si       0.000000000   0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
  8 8 8 0 0 0 
```

对于熟悉的闪锌矿结构，这里的CELL_PARAMETER是常见写法，与上面按照一般方法从cif获得的原胞等价。

赝势文件由ld1.x生成，ld1.x的输入文件来自[pslibrary1.0](http://www.quantum-espresso.org/pseudopotentials/pslibrary)，推荐使用超软赝势，相比模守恒赝势有较小的截断能。赝势使用更多内容见[这里。](../../../06/03/PPlib/)

赝势下载：
<a href="../../../../../img/Si.UPF">Si.UPF</a>
<a href="../../../../../img/C.UPF">C.UPF</a>

pseudo_dir='./'是赝势文件所在目录，'./'表示赝势文件在当前目录。outdir='./tmp'是输出电荷、波函数等文件所在目录，之后的nscf等计算要读入这些文件，所以要保持一致。prefix='pwscf'表示outdir目录下文件前缀，后续计算也要保持一致。

将输入文件保存成relax.inp，和两个赝势文件放在同一目录，运行```pw.x < relax.inp > relax.out``` 开始计算。（并行计算，安装了openmpi则运行```mpirun -np 16 pw.x < relax.inp > relax.out```，其中，16是使用的核数。）

在vc-relax（relax，scf）计算时，程序会找体系的点群对称操作以减少计算量，并在弛豫时保持对称性，如果想要允许弛豫改变对称性，需设置`nosym=.true.,noinv=.true.`。寻找对称性时考虑了FFT格点，有可能会舍去部分晶体点群操作，有必要时需要设置`nr1, nr2, nr3`以允许这部分点群操作。


计算结束后，运行
```bash
awk  '/Begin final coordinates/,/End final coordinates/{print $0}' relax.out
```

，得到以下输出

```
Begin final coordinates
     new unit-cell volume =    141.54631 a.u.^3 (    20.97500 Ang^3 )
     density =      3.17432 g/cm^3

CELL_PARAMETERS (angstrom)
   2.188890250   2.188890250   0.000000000
   0.000000000   2.188890250   2.188890250
   2.188890250  -0.000000000   2.188890250

ATOMIC_POSITIONS (crystal)
Si       0.000000000  -0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
End final coordinates
```

即为弛豫后的晶格结构（或在输出文件中可以找到），可以看出晶格常数理论值为4.378Å。结构弛豫通过力的计算得到总能-位形曲面上的局部极小值，为了模拟实际，需要初始结构与实际情况足够接近。这里输出的density与ATOMIC_SPECIES中设置的原子质量有关。relax计算包括多个自洽计算，查看自洽计算得到的总能用

```bash
grep '!' relax.out
```

输出为：
```
!    total energy              =     -22.67776498 Ry
!    total energy              =     -22.67819319 Ry
!    total energy              =     -22.67819977 Ry
!    total energy              =     -22.67819977 Ry
!    total energy              =     -22.67821030 Ry
```
可见，这里relax经历了了5个自洽计算步骤后达到收敛，最后一个是结构弛豫计算得到的体系总能。注意，自洽计算总能只具有相对意义，不同赝势计算得到的总能不能比较，用相同赝势计算的总能可以求差值。


#### 1.2.1 占据数、展宽的设置

对于导体，由于存在半满的能带，而只有占据的能级对于总能有贡献，费米能级附近的能级在自洽计算时可能出现相邻两次自洽迭代一次占据一次不占据，导致总能，尤其是单电子能级之和震荡的情况。计算总能时，除了使用足够密的k点网格以外，设置占据数的展宽，考虑费米能级附近的能级都对总能有一定贡献，可以让计算更容易收敛，并且得到较准确的能带和态密度。k点和展宽的设置，不仅对于总能，而且对于所有需要在整个布里渊区积分的物理量的计算收敛有影响。

建议设置```occupation='smearing',smearing='gaussian'```，使用高斯展宽。对于不同的材料调整degauss的值，对于有带隙的材料，```degauss=1d-9```，也就是接近0就可以，对于没有带隙的导体材料，degauss从小尝试到大，取值约0.01Ry量级，至少要达到或接近若干未占据能级，k点足够多的基础上（见1.2.2），测试degauss一要总能几乎不变，二要输出中的“smearing contribution TS”足够小，建议小于$1\times10^{-4}$ Ry/atom。

#### 1.2.2 自洽计算k点的设置

总能计算需要对电荷积分，由于QE中的Kohn-Sham方程是在k空间中进行的，需要在k空间均匀取点进行电荷的积分，原则上更密的网格得到的电荷更准确，但是考虑的到计算量，实际计算的k点是较为有限的，对于绝缘体，$0.5Å^{-1}$间距的k点网格一般可以实现收敛，设置

```
K_POINTS {automatic}
nk1, nk2, nk3, k1, k2, k3
```
其中，前三个数nk1, nk2, nk3是倒格子三个基矢方向的k点网格，由于对称性可能实际计算k点个数有约化，nk的值对于较长的CELL基矢方向取值较小，建议绝缘体设置k点间距在$0.5Å^{-1}$以下，对于导体，nk的值较大，需要同时结合degauss测试收敛。后三个数k1, k2, k3是设置k点网格是否含相应的0点。

### 1.3 自洽计算的输入文件
由于pw.x约定在同一目录下运行vc-relax和relax计算后的scf或bands计算会读取弛豫后的结构。所以，将calculation='vc-relax'改成calculation='scf'，其他部分与上一步输入文件相同。另外，vc-relax和relax计算最后一步包含了最终结构的scf计算，所以这里省去这一步骤。

### 1.4 能带计算的输入文件
能带计算需要设置k点路径，我们参考文献[4]给出的特殊k点坐标，选取了路径X-Γ-L。在relax计算的同一目录下，将能带计算输入文件如下保存为nscf_b.inp，运行```pw.x < nscf_b.inp > nscf_b.out```。

```
&CONTROL
    calculation='bands', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    nat= 2, ntyp= 2,
    occupations = 'smearing', smearing = 'gauss', degauss = 1.0d-9
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Si 1.0 Si.UPF
  C  1.0 C.UPF
CELL_PARAMETERS (angstrom)
   2.174000000   2.174000000   0.000000000
   0.000000000   2.174000000   2.174000000
   2.174000000   0.000000000   2.174000000
ATOMIC_POSITIONS (crystal)
Si       0.000000000   0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
K_POINTS {crystal_b}
3
0.5 0.0 0.5 30
0.0 0.0 0.0 30
0.5 0.5 0.5 1
```

使用QE的后处理程序bands.x将能带结果转为易于画图的格式，将以下代码保存为bds.inp，运行bands.x < bands.inp > bands.out
```
&bands
prefix='pwscf',
outdir='tmp'
filband='bd.dat'
lp=.true.
/
```
这一个步骤是读取pw.x的输出，运行成功后，会生成filband所命名的文件，这里是bd.dat，bd.dat的内容见[这里](https://github.com/yyyu200/DFTbook/blob/master/_data/bd.dat)，是每个k点的能级值，注意这里的能级数值只有相对的意义，能量的参考点是不确定的。各个k点的能级值是从小到大排列的。

可见，bands.x只是后处理，pw.x输出中也能找到这些能级的值，另外tmp/pwscf.save/K00001/eigenval.xml等文件（每个K点一个文件夹）内也有足以画图的数据，且有效位数更高。bands.x的输入不支持windows换行符，需要结尾的“/”号之后额外换行，或用dos2unix处理之后在linux下编辑，windows版本的bands.exe也有这个问题。

通常，画能带图时，绝缘体用价带顶作为能量零点，导体用费米能级作为能量零点。接下来可以用QE自带的plotband.x画能带图，但是画图的自定义效果不够，这里不再介绍，这里为了用bd.dat画能带，使用python运行以下代码：

```
# -*- coding: utf-8 -*-
"""
@author: yyyu200@163.com
"""

import numpy as np

feig=open('bd.dat')
ymin=-20
ymax=20
nband=4 # this is the valence band number, for insulators only
dline=30 # vertical line intervals

l=feig.readline()
nbnd=int(l.split(',')[0].split('=')[1])
nks=int(l.split(',')[1].split('=')[1].split('/')[0])

eig=np.zeros((nks,nbnd),dtype=float)
for i in range(nks):
    l=feig.readline()
    count=0
    if nbnd%10==0:
        n=nbnd//10
    else:
        n=nbnd//10+1
    for j in range(n):
        l=feig.readline()
        for k in range(len(l.split())):
            eig[i][count]=l.split()[k]
            count=count+1
            
feig.close()

import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt

p1=plt.subplot(1, 1, 1)

F=plt.gcf()
F.set_size_inches([3,5])
lw=1.2 # line width

plt.xlim([0,nks-1]) # 201 points
plt.ylim([ymin,ymax])
#plt.xlabel(r'$k (\AA^{-1})$',fontsize=16)
plt.ylabel(r' E (eV) ',fontsize=16)

eig_vbm=max(eig[:,nband-1])
eig_cbm=min(eig[:,nband])
Gap=eig_cbm-eig_vbm

plt.title("Band gap="+str(Gap)[0:8]+" eV")  # for insulators only
for i in range(nbnd):
    line1=plt.plot( eig[:,i]-eig_vbm,color='r',linewidth=lw ) 

vline=dline
while vline<nks-1:
    plt.axvline(x=vline, ymin=ymin, ymax=ymax,linewidth=lw,color='black')
    vline=vline+dline

plt.xticks( (0,30,60), ('X', r'${\Gamma}$', 'L') )

plt.savefig('pwband.png',dpi=500)

```

计算能带结果与文献比较如下[[5]](http://www.ioffe.ru/SVA/NSM/Semicond/SiC/bandstr.html)。X-Γ带隙实验值为2.416eV，计算值为1.378eV，由于交换关联近似的原因，PBE计算出的带隙存在偏小的问题。

<p align="left">
    <img src="../../../../../img/pwband.png" width="200"/>
    <img src="../../../../../img/mband_3C_SiC.gif" width="300"/>
</p>

## 2. 计算金属铜能带、功函数
导体的功函数是指导体的费米能级到真空能级的差值，对于绝缘体来说，一般用类似的概念，如电离势（ionic potential）和亲和能（electron affinity）来表示价带顶和导带底与真空能级的差值。pw.x通过scf计算得到自洽电荷密度，进而得到CELL内各个点的势能，同时得到体系的费米能级。在pw.x中，由于平面波程序的周期性边界条件，能级的参考点是不确定的，所以在块材（bulk）的计算中无法得到真空能级。为了同时得到费米能级和真空能级，需要建立平板（slab）模型，在CELL中留空，留空的区域即是真空，电荷密度基本为0，所以势能是常数，即真空能级。在slab计算中费米能级（绝缘体的VBM）由于表面态的存在而不准确，而slab内的平均势能和真空平均势能是准确的；在bulk计算中，费米能级和平均势能的差值是准确的。认为slab内平均势能和bulk平均势能是对应的，则可以得到真空能级和费米能级的差值，即功函数，参考文献[6]。

功函数与晶向、重构、吸附等密切相关，这里考虑金属Cu未重构的（110）表面，对于绝缘体的电离势可以通过类似方法得到。

### 2.1 计算铜的晶格常数、能带和态密度

用首先计算面心立方铜的原胞，用```calculation='vc-relax'```优化晶格常数。实验晶格常数为3.61Å。注意这里的smearing='mp'（以及'mv'）只适用于导体。
```
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    nat= 1, ntyp= 1,
    occupations = 'smearing', smearing = 'mp', degauss = 1.0d-2
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Cu 63.546 Cu.UPF
CELL_PARAMETERS (angstrom)
  1.8050000   1.8050000   0.0000000 
  0.0000000   1.8050000   1.8050000 
  1.8050000   0.0000000   1.8050000 
ATOMIC_POSITIONS (crystal)
Cu  0.000000000   0.000000000   0.000000000
K_POINTS {automatic}
  13 13 13 0 0 0 
```

运行`awk  '/Begin final coordinates/,/End final coordinates/{print $0}' vc.out`得到：

```
Begin final coordinates
     new unit-cell volume =     80.23493 a.u.^3 (    11.88959 Ang^3 )
     density =      8.87504 g/cm^3

CELL_PARAMETERS (angstrom)
   1.811530376   1.811530376   0.000000000
   0.000000000   1.811530376   1.811530376
   1.811530376   0.000000000   1.811530376

ATOMIC_POSITIONS (crystal)
Cu       0.000000000   0.000000000   0.000000000
End final coordinates
```

可见，用PBE交换关联近似计算得到晶格常数理论值是1.811530376*2=3.6231Å。运行```grep 'smearing contrib.' vc.out ```，
```
     smearing contrib. (-TS)   =       0.00000236 Ry
     smearing contrib. (-TS)   =       0.00000333 Ry
     smearing contrib. (-TS)   =       0.00000349 Ry
     smearing contrib. (-TS)   =       0.00000350 Ry
     smearing contrib. (-TS)   =       0.00000351 Ry
```
结果在可接受范围。

运行```grep Fermi vc.out |tail -1```，得到费米能级（以scf输出的费米能级为准）。
```
     the Fermi energy is    12.7631 ev
```

计算态密度（这一步非计算功函数所需），nscf.inp输入如下，使用了$53^{3}=148877$个k点的网格（对称性约化，实际计算了3654个点），以得到较为平滑的DOS曲线。
```
&CONTROL
    calculation='nscf', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    nat= 1, ntyp= 1,
    occupations = 'smearing', smearing = 'mp', degauss = 1.0d-2
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Cu 63.546 Cu.UPF
CELL_PARAMETERS (angstrom)
  1.8050000   1.8050000   0.0000000
  1.8050000   0.0000000   1.8050000
  0.0000000   1.8050000   1.8050000
ATOMIC_POSITIONS (crystal)
Cu  0.000000000   0.000000000   0.000000000
K_POINTS {automatic}
  53 53 53 0 0 0
```
将以下输入参数保存为dos.inp，运行```dos.x < dos.inp > dos.out```

```
&dos 
 prefix='pwscf'
 outdir='./tmp'
 ngauss=1
 degauss=1.5d-2
 DeltaE=1.0d-2
 fildos='cu.dos'
/ 
```

将nscf计算输入中K_POINTS改为如下，设置```calculation='bands'```，计算能带。
```
K_POINTS {crystal_b}
6
0.5 0.5 0.5 50
0.0 0.0 0.0 50
0.5 0.0 0.5 20
0.625 0.25 0.625 0
0.375 0.375 0.75 50
0.0 0.0 0.0 1
```

计算得到的能带和态密度如下图，画图脚本见[这里](../../../../../img/cu_plotbanddos.py)，画图时要删掉第120个k点（U点）的能级（能带和态密度不属于计算功函数的步骤，这里作为计算金属bulk的示例）。
<p align="left">
    <img src="../../../../../img/pwbanddos.png" width="1000"/>
</p>

### 2.2 建立slab模型并做结构驰豫
建立slab模型的一般方法见[这里](../../07/TransCell/#平板slab模型的建立)。建立slab模型使用前一节得到的理论晶格常数，已知原胞时可以先对原胞做变换$$P_{1}$$得到晶胞，

$$
P_{1}=\quad
\begin{pmatrix}
-1 & 1 & 1 \\
 1 &-1 & 1 \\
 1 & 1 &-1 \\
\end{pmatrix}
\quad
$$

晶胞的POSCAR如下：
```
Cu unit cell
   1.00000000000000
     3.6231000000000000    0.0000000000000000    0.0000000000000000
     0.0000000000000000    3.6231000000000000    0.0000000000000000
     0.0000000000000000    0.0000000000000000    3.6231000000000000
     Cu
   4
Direct
  0.0000000000000000  0.0000000000000000  0.0000000000000000
  0.0000000000000000  0.5000000000000000  0.5000000000000000
  0.5000000000000000  0.0000000000000000  0.5000000000000000
  0.5000000000000000  0.5000000000000000  0.0000000000000000
```

运行build.py

```python
from build import CELL

unitcell=CELL("cu4.vasp")

miller_index=[1,1,0]
slab=unitcell.makeslab(miller_index, layer=5, vacuum=20)
slab.pop(position='top')
#slab.print_poscar("./cuslab.vasp")
slab.print_pwinput("")
```
其中，加入真空时，CELL的面内基矢不变，删掉最顶端的一个原子(slab.pop())，以保持slab的两个表面的对称性，不引入两个表面不对称会形成的偶极场（对于Cu的110面这个例子，由于对z方向做>镜面加平移可以复原，不删除这个原子两个表面也是等势能的），z方向增加20Å，原子分数坐标随之变换。得到部分pw.x的部分输入内容，pw.x其余的输入部分手动补全，
```
&SYSTEM
  ibrav= 0, nat= 19, ntyp= 1,  
/
ATOMIC_SPECIES
Cu 1.0 Cu.UPF
CELL_PARAMETERS (angstrom)
 2.5619185789  0.0000000000  0.0000000000
 0.0000000000  3.6231000000  0.0000000000
 0.0000000000  0.0000000000 43.0572672103
ATOMIC_POSITIONS (crystal)
  Cu  0.0000000000  0.0000000000  0.2322488316
  Cu  0.5000000000  0.5000000000  0.2619989614
  Cu  0.0000000000  0.0000000000  0.2917490912
  Cu  0.0000000000  0.0000000000  0.7677511684
  Cu  0.0000000000  0.0000000000  0.3512493509
  Cu  0.0000000000  0.0000000000  0.4107496105
  Cu  0.0000000000  0.0000000000  0.4702498702
  Cu  0.0000000000  0.0000000000  0.5297501298
  Cu  0.0000000000  0.0000000000  0.5892503895
  Cu  0.0000000000  0.0000000000  0.6487506491
  Cu  0.0000000000  0.0000000000  0.7082509088
  Cu  0.5000000000  0.5000000000  0.3214992210
  Cu  0.5000000000  0.5000000000  0.3809994807
  Cu  0.5000000000  0.5000000000  0.4404997403
  Cu  0.5000000000  0.5000000000  0.5000000000
  Cu  0.5000000000  0.5000000000  0.5595002597
  Cu  0.5000000000  0.5000000000  0.6190005193
  Cu  0.5000000000  0.5000000000  0.6785007790
  Cu  0.5000000000  0.5000000000  0.7380010386
```
<p align="left">
    <img src="../../../../../img/cu110slab.png" width="1000"/>
</p>

得到输入文件如下，这里的结构驰豫应该用```calculation='relax'```进行。在早期的研究中，常固定slab内部原子，只允许最接近表面的1～2层原子驰豫。现在常固定中间一个原子，等效于所有原子允许驰豫，可以避免slab的整体漂移（在relax中固定原子位置采用在原子坐标后面写" 0 0 0"，分别固定坐标的三个分量）。

```
&CONTROL
    calculation='relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-4
/
&SYSTEM
    ibrav= 0,
    nat= 19, ntyp= 1,
    occupations = 'smearing', smearing = 'mp', degauss = 1.0d-2
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
K_POINTS {automatic}
  8 8 1 0 0 0 
ATOMIC_SPECIES
Cu 1.0 Cu.UPF
CELL_PARAMETERS (angstrom)
 2.5619185789  0.0000000000  0.0000000000
 0.0000000000  3.6231000000  0.0000000000
 0.0000000000  0.0000000000 43.0572672103
ATOMIC_POSITIONS (crystal)
  Cu  0.0000000000  0.0000000000  0.2322488316
  Cu  0.5000000000  0.5000000000  0.2619989614
  Cu  0.0000000000  0.0000000000  0.2917490912
  Cu  0.0000000000  0.0000000000  0.7677511684
  Cu  0.0000000000  0.0000000000  0.3512493509
  Cu  0.0000000000  0.0000000000  0.4107496105
  Cu  0.0000000000  0.0000000000  0.4702498702
  Cu  0.0000000000  0.0000000000  0.5297501298
  Cu  0.0000000000  0.0000000000  0.5892503895
  Cu  0.0000000000  0.0000000000  0.6487506491
  Cu  0.0000000000  0.0000000000  0.7082509088
  Cu  0.5000000000  0.5000000000  0.3214992210
  Cu  0.5000000000  0.5000000000  0.3809994807
  Cu  0.5000000000  0.5000000000  0.4404997403
  Cu  0.5000000000  0.5000000000  0.5000000000 0 0 0
  Cu  0.5000000000  0.5000000000  0.5595002597
  Cu  0.5000000000  0.5000000000  0.6190005193
  Cu  0.5000000000  0.5000000000  0.6785007790
  Cu  0.5000000000  0.5000000000  0.7380010386
```

### 2.3 获取静电势并得到功函数
用pp.x得到静电势，如下文件保存为pp.inp，运行```pp.x < pp.inp > pp.out```，

```
&INPUTPP
   outdir='./tmp'
   plot_num=11
   filplot='pp11.dat'
/
```

用average.x对面内势能取平均，并对垂直表面方向势能取移动平均值，average.x输入说明见[这里](https://github.com/QEF/q-e/blob/master/PP/src/average.f90)，输入文件average.inp如下，运行```average.x< average.inp >average.out```：

```
1
pp11.dat
1
1000
3
4.8681
```

其中，最后一行4.8681是移动平均的窗口长度,设置为驰豫后slab中间部分的单元长度，单位是Bohr。输出avg.dat见[这里](../../../../../img/avg.dat)，包括三列，第一列是z方向格点，第二列是势能在xy面内的平均，第三列是第二列在z方向移动平均。通过进一步拟合，得到slab中间势能为-0.00714Ry，真空势能为0.7042Ry。对于原胞的平均静电势能，可以对势能直接求平均值，得到原胞的平均势能是0.52914Ry，由前面计算得到原胞费米能级12.7631eV=0.9381Ry。

slab中费米能级是5.2158eV，不加原胞修正的功函数是4.369eV。

而加了原胞修正的功函数为：

$$0.7042-0.9381+[0.5294-(-0.0071)]=0.3026Ry=4.115eV$$.

势能作图如下，红色线是xy面内平均势能，蓝色线是z方向移动平均，绿色线是slab内部平均势能示意。

<p align="left">
    <img src="../../../../../img/cu_110avg.png" width="1000"/>
</p>

### 2.4 加电场的自洽计算

对于slab模型、分子等，有时由于对称性的破坏，在平面波程序的周期性边界条件下，会造成人为的电场，需要加入一个dipole去消除；另外，有时需要研究体系在电场下的电荷变化，这时需要加电场的计算。在真空层中加入一个电偶极子，也就是引入一个沿着z方向（z是垂直表面方向，由edir设置）的锯齿形势能，这个势能在slab处上升，上升的梯度为电场强度eamp，在真空一个很小的宽度（eopreg）内下降。计算是否要做relax，根据实际情况定。设置需要用到edir,emaxpos,eopreg,eamp,tefield和dipfield。当slab位于Cell中间（约0.5）时（输入其余部分略）：

```
&CONTROL
  tefield=true., dipfield=.true.
/
&SYSTEM
  edir = 3,
  eamp = 0.001,
  emaxpos=0.99,
  eopreg=0.01,
/
```
偶极矩的位置在z方向的0.99~1.0之间。

注：QE中另一种加电场的方法是用berry phase（BP）加入电场，适用的场合不同，BP方法要求体系是没有真空层的，或者有真空层但是电场在slab的面内（x，y方向）。berry phase电场设置参数

```
  lelfield=.true., nberrycyc=3
...
  efield_cart(3)=0.001d0
```

对于导体不适用加电场，（1）dipole方法，金属slab加电场会让正负电荷在两个表面积累，这种电荷转移的量很大，QE计算几乎不可能收敛。（2）berry phase方法，由于berry phase是在倒空间一个闭合的曲面上的积分，金属的占据态对应k点集合不是闭合的曲面，无法定义Berry phase。

## 3. 计算氮化硼的光学性质

计算闪锌矿结构立方氮化硼的介电函数。

### 3.1 用epsilon.x计算光学性质
epsilon.x计算能级间偶极跃迁得到介电常数，根据以下[公式](https://en.wikipedia.org/wiki/Fermi%27s_golden_rule)得到介电常数虚部[7]：

$\epsilon_2 (\omega)= \frac{4 \pi ^2} {m^2\omega^2} \sum_{V,C} {\int_{BZ} {d^3 k  \frac {2}{(2\pi)^{3}}  \lvert eM_{CV}(K) \rvert ^2 \cdot \delta[E_{C}(k)-E_{V}(k)-h\omega]}}$

而介电常数实部可以由虚部通过Kramers-Kronig关系变换得到。通过能带结构，可以计算得到全部的光学常数。

epsilon.x计算目前仅支持模守恒赝势。首先优化晶格常数，运行```pw.x < vc.inp > vc.out```，vc.inp如下：
```
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    nat= 2, ntyp= 2,
    occupations = 'fixed'
    ecutwfc= 80, ecutrho = 320,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  B  10.811   B_ONCV_PBE-1.0.upf  
  N  14.00674 N.oncvpsp.upf
CELL_PARAMETERS (angstrom)
   1.807500000   1.807500000  -0.000000000
   0.000000000   1.807500000   1.807500000
   1.807500000  -0.000000000   1.807500000
ATOMIC_POSITIONS (crystal)
B        0.000000000   0.000000000   0.000000000
N        0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
  13 13 13 0 0 0

```
赝势文件见
[B_ONCV_PBE-1.0.upf](../../../../../img/B_ONCV_PBE-1.0.upf)
[N.oncvpsp.upf](../../../../../img/N.oncvpsp.upf)。

得到晶格常数PBE计算值3.6215Å。光学性质需要较密的k点，并且需要关掉对称性，设置```nosym=.true,noinv=.true```，计算的带个数nbnd要大一些，做一次nscf计算：
```
&CONTROL
    calculation='nscf', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    nat= 2, ntyp= 2,
    occupations = 'smearing', smearing='gauss', degauss=1d-9,
    ecutwfc= 80, ecutrho = 320,
    nbnd=30
    nosym=.true,
    noinv=.true,
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  B  10.811   B_ONCV_PBE-1.0.upf  
  N  14.00674 N.oncvpsp.upf
CELL_PARAMETERS (angstrom)
   1.810733563   1.810733563   0.000000000
  -0.000000000   1.810733563   1.810733563
   1.810733563  -0.000000000   1.810733563
ATOMIC_POSITIONS (crystal)
B        0.000000000   0.000000000   0.000000000
N        0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
  13 13 13 0 0 0
```
以下内容保存为epsilon.inp，运行epsilon.x < epsilon.inp > epsilon.out：
```
&inputpp
  outdir='./tmp'
  calculation='eps'
/
&energy_grid
  smeartype='gauss'
  intersmear=0.50
  intrasmear=0.0
  wmin=0.0
  wmax=60.0
  nbndmin=1
  nbndmax=0
  nw=2000
  shift=0.0
/
```
输出4个文件eels_pwscf.dat,epsi_pwscf.dat,epsr_pwscf.dat,ieps_pwscf.dat，分别是eels谱（电子能量损失谱），介电函数的虚部、实部，虚轴上的介电函数。前三个结果见下图，与实验及其他计算结果比较见[8]。

<p align="left">
    <img src="../../../../../img/bn_epsilon.png" width="1000"/>
</p>

固体介电常数、电导率、折射率一般来说都是复数，知道其一可以确定其余两个，进而还可以得到吸收系数，反射率，三者关系如下表[9]：

<p align="left">
    <img src="../../../../../img/optic_relation.png" width="1000"/>
</p>

吸收系数 $\alpha= \frac{2k \omega }{c}$

反射率 $R=\frac{(1-n)^2+k^2}{(1+n)^2+k^2}$

## 4. 声子谱的计算
计算GaAs的声子谱。QE中声子计算是通过DFPT进行的，通过加入berry phase电场计算电荷响应得到介电常数，新版本（>=6.x）也开始支持finite displacements method。参考安装包q-e-qe-6.3\PHonon\examples\ example1 （$\Gamma$点）和example2 （色散），画图这里用的是python。

首先优化晶格常数，用pw.x进行一次vc-relax计算（晶格常数实验值5.715Å，计算值5.585Å）。GGA计算出的极化往往较实际偏大，而LDA往往偏小，在极化$4\pi P$接近电位移矢量D时介电常数发散（$4\pi P$总是小于D），$\epsilon=1+\frac{4\pi P}{D-4\pi P}$，所以，极化偏大对介电常数影响较大。这里GaAs按照文献中的做法使用了LDA模守恒赝势，赝势文件见[Ga](../../../../../img/Ga.SG15.LDA.UPF)，[As](../../../../../img/As.SG15.LDA.UPF)。

```
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5, etot_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 2,
    celldm(1) = 10.7997848
    nat= 2, ntyp= 2,
    occupations = 'fixed', nbnd=10
    ecutwfc= 120, ecutrho = 480,
    input_dft='pz'
/
&ELECTRONS
    electron_maxstep = 100,    conv_thr = 1.0d-9,    mixing_mode = 'plain'
    mixing_beta = 0.7d0,    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
   press = 0.00 ,
   press_conv_thr=0.1
   cell_dynamics = 'bfgs' ,
/
ATOMIC_SPECIES
 Ga  69.7230 Ga.SG15.LDA.UPF
 As  74.9216 As.SG15.LDA.UPF
ATOMIC_POSITIONS (crystal)
Ga       0.000000000   0.000000000   0.000000000 0 0 0
As       0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
11 11 11 0 0 0
```

### 4.1 单个q点的ph.x计算

vc-relax计算之后用最终结构做一次scf计算（否则后续计算会出错）。

将以下文件保存为ph.inp，运行```ph.x < ph.inp > ph.out```

```
phonons of GaAs at Gamma
 &inputph
  tr2_ph=1.0d-14,
  prefix='pwscf',
  outdir='./tmp',
  epsil=.true.,
  amass(1)=69.7230,
  amass(2)=74.9216,
  fildyn='gs.dynG',
 /
0.0 0.0 0.0
```

在输出ph.out中可以找到高频介电常数张量$\epsilon_{ij}(\infty)$（实验值10.86，Ref.[10]），以及玻恩有效电荷张量$Z_{ij}$（实验值2.07）：
```
          Dielectric constant in cartesian axis 

          (      13.578406136      -0.000000000       0.000000000 )
          (      -0.000000000      13.578406136      -0.000000000 )
          (       0.000000000      -0.000000000      13.578406136 )

          Effective charges (d Force / dE) in cartesian axis

           atom      1   Ga 
      Ex  (        2.04400        0.00000        0.00000 )
      Ey  (        0.00000        2.04400       -0.00000 )
      Ez  (        0.00000       -0.00000        2.04400 )
           atom      2   As 
      Ex  (       -2.04051       -0.00000       -0.00000 )
      Ey  (       -0.00000       -2.04051        0.00000 )
      Ez  (       -0.00000        0.00000       -2.04051 )
```

此时计算出$\Gamma$点声子频率：
```
     Diagonalizing the dynamical matrix

     q = (    0.000000000   0.000000000   0.000000000 )

 **************************************************************************
     freq (    1) =      -2.183574 [THz] =     -72.836200 [cm-1]
     freq (    2) =      -2.183574 [THz] =     -72.836200 [cm-1]
     freq (    3) =      -2.183574 [THz] =     -72.836200 [cm-1]
     freq (    4) =       7.777154 [THz] =     259.417942 [cm-1]
     freq (    5) =       7.777154 [THz] =     259.417942 [cm-1]
     freq (    6) =       7.777154 [THz] =     259.417942 [cm-1]
 **************************************************************************
```
但是，可以看到ph.x输出的$\Gamma$点声学声子不等于0，且没有LO-TO分裂。在声子平衡位置，由对称性可知LO与TO是简并的。但是，极性材料中LO与长程库仑作用耦合而TO不耦合造成LO-TO分裂[11]。为了加入Acoustic Sum Rule和non-analytic term修正，将以下文件保存为dynmat.inp，运行```dynmat.x < dynmat.inp > dynmat.out```

```
&input
  fildyn='gs.dynG'
  q(1)=0,q(2)=0,q(3)=0.1
  asr='crystal'
  filout='dynmat.dat'
/
```

其中，q(1,2,3)是LO-TO分裂的方向，对于立方晶系各向同性不全等于0即可。dynmat.x加入了非解析项修正，对于q=0点加入了声学声子求和规则，再次对角化动力学矩阵。输出的dynmat.out中可以找到$\Gamma$点声子频率如下（实验值：TO=271$cm^{-1}$，LO=293$cm^{-1}$）。第三列是红外强度。

```
# mode   [cm-1]    [THz]      IR
    1     -0.00   -0.0000    0.0000
    2      0.00    0.0000    0.0000
    3      0.00    0.0000    0.0000
    4    259.42    7.7771    2.6645
    5    259.42    7.7771    2.6645
    6    277.32    8.3139    2.6645
```

### 4.2 声子色散计算
首先，用ph.x在q点网格上通过DFPT计算动力学矩阵，输入ph.inp如下（需要在scf计算之后运行，如果接在vc-relax之后运行ph.x，运行q2r.x时会出错），运行```ph.x < ph.inp > ph.out```：

```
phonons of GaAs q-grid
 &inputph
  tr2_ph=1.0d-12,
  prefix='pwscf',
  outdir='./tmp',
  amass(1)=69.7230,
  amass(2)=74.9216,
  fildyn='gs666.dyn',
  ldisp=.true.,
  nq1=6, nq2=6, nq3=6
 /
```

ph.x计算结束后（这一步计算量很大，24核算了约30小时，q点可能取多了，截断能也偏大了🤔）用q2r.x将动力学矩阵由q空间变换到实空间，输入q2r.inp如下，运行```q2r.x < q2r.inp > q2r.out```：
```
 &input
   fildyn='gs666.dyn', zasr='simple', flfrc='gs666.fc'
 /
```

matdyn.x通过实空间nq1×nq2×nq3超胞上interatomic force constants计算任意q点声子频率。对于非立方材料各项异性的LO-TO分裂需要将$\Gamma$点写两次，立方材料则不需要。将以下保存为matdyn.inp，运行```matdyn.x < matdyn.inp > matdyn.out```，计算声子色散，q点定义见安装包[/Doc/brillouin_zones.pdf](https://github.com/QEF/q-e/blob/master/Doc/brillouin_zones.pdf)，可以用字母表示特殊q点，也可以用笛卡尔坐标（2$\pi$/alat为单位）。

```
&input
  asr='simple',
  amass(1)=69.7230,
  amass(2)=74.9216,
  flfrc='gs666.fc',
  flfrq='gs.freq',
  q_in_band_form=.true.,
/
6
  gG    40
  X     10
  U      0
  K     40
  gG    40
  L     1
```

输出'gs.freq'文件格式和1.4节计算电子能带的bd.dat文件格式是一致的，画图参考1.4节的脚本，声子色散见下图，画图时要删掉第50个（U点）和第51个（K点）q点中的一个，结果与文献中比较见[10]。matdyn.x也可以用来计算声子态密度、电声子耦合系数（见qe_release_6.4/PHonon/examples/example03）。

<p align="left">
    <img src="../../../../../img/gaas_phonon.png" width="1000"/>
</p>

### 4.3 电子-声子耦合系数

#### 4.3.1 使用PHonon模块计算电子-声子耦合系数

面心立方Pb，晶格常数9.316 Bohr（4.93Å）。vc-relax得到优化晶格常数是9.5090 Bohr。

以下计算分为7个步骤，
1. 较密k点的scf计算
输入如下，注意，这一步加入了`la2F=.true.`，k点设置为16×16×16的网格，此处必须是第2步k点的整数倍。
```
&CONTROL
    calculation='scf', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 2,
    celldm(1) = 9.509, nat= 1, ntyp= 1,
    nat= 1, ntyp= 1,
    occupations = 'smearing', smearing = 'mp', degauss = 1.0d-2
    ecutwfc= 50, ecutrho = 500,
    la2F=.true.
/
&ELECTRONS
    conv_thr = 1.0d-9,
    mixing_beta = 0.7d0,
    diagonalization = 'david'
/
&IONS
    ion_dynamics='damp'
/
&CELL
   press = 0.00 ,
   press_conv_thr=0.1
   cell_dynamics = 'bfgs' ,
/
ATOMIC_SPECIES
 Pb  207.2 Pb.pbe-dn-rrkjus_psl.1.0.0.UPF
ATOMIC_POSITIONS (crystal)
Pb       0.000000000   0.000000000   0.000000000
K_POINTS {automatic}
16 16 16 0 0 0
```

2. 正常k点的scf计算

```
&CONTROL
    calculation='scf', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 2,
    celldm(1) = 9.509, nat= 1, ntyp= 1,
    nat= 1, ntyp= 1,
    occupations = 'smearing', smearing = 'mp', degauss = 1.0d-2
    ecutwfc= 50, ecutrho = 500,
/
&ELECTRONS
    conv_thr = 1.0d-9,
    mixing_beta = 0.7d0,
    diagonalization = 'david'
/
&IONS
    ion_dynamics='damp'
/
&CELL
   press = 0.00 ,
   press_conv_thr=0.1
   cell_dynamics = 'bfgs' ,
/
ATOMIC_SPECIES
 Pb  207.2 Pb.pbe-dn-rrkjus_psl.1.0.0.UPF
ATOMIC_POSITIONS (crystal)
Pb       0.000000000   0.000000000   0.000000000
K_POINTS {automatic}
8 8 8 0 0 0
```

3. ph.x计算电声子系数

```
Electron-phonon coefficients
&inputph
  tr2_ph=1.0d-10,
  prefix='pwscf',
  fildvscf='pbdv',
  amass(1)=207.2,
  outdir='./tmp',
  fildyn='pb.dyn',
  electron_phonon='interpolated',
  el_ph_sigma=0.005,
  el_ph_nsigma=10,
  trans=.true.,
  ldisp=.true.
  nq1=4, nq2=4, nq3=4
/
```

4. q2r.x变换力常数

```
 &input
  zasr='simple',  fildyn='pb.dyn', flfrc='pb444.fc', la2F=.true.
 /
```

5. matdyn.x计算q路径上声子线宽

声子线宽$\gamma$

```
&input
   asr='simple',  amass(1)=207.2,
   flfrc='pb444.fc', flfrq='pb444.freq', la2F=.true., dos=.false.
/
 19
 0.000 0.0 0.0     0.0
 0.125 0.0 0.0     0.0
 0.250 0.0 0.0     0.0
 0.375 0.0 0.0     0.0
 0.500 0.0 0.0     0.0
 0.750 0.0 0.0     0.0
 1.000 0.0 0.0     0.0
 0.825 0.125 0.125 0.0
 0.750 0.250 0.250 0.0
 0.625 0.375 0.375 0.0
 0.500 0.500 0.500 0.0
 0.325 0.325 0.325 0.0
 0.250 0.250 0.250 0.0
 0.125 0.125 0.125 0.0
 0.000 0.000 0.000 0.0
 0.125 0.125 0.000 0.0
 0.250 0.250 0.000 0.0
 0.325 0.325 0.000 0.0
 0.500 0.500 0.000 0.0
```

6. matdyn.x计算 $\lambda$ 和 $\alpha^{2} F(\omega)$

```
&input
   asr='simple',  amass(1)=207.2,
   flfrc='pb444.fc', flfrq='pb444.freq', la2F=.true., dos=.true.
   fldos='phonon.dos', nk1=10, nk2=10, nk3=10, ndos=50
/
```

7. lambda.x计算 $\lambda$ 和 $T_C$

```
10  0.12  1    ! emax (something more than highest phonon mode in THz), degauss, smearing method
    8          ! Number of q-points for which EPC is calculated,
    0.0000000  0.0000000  0.0000000   1.00  ! the first q-point, use kpoints.x program to calculate
    -0.2500000 -0.2500000  0.2500000   8.00  ! q-points and their weight
    -0.5000000 -0.5000000  0.5000000   4.00  !
     0.0000000  0.0000000  0.5000000   6.00  ! 4th q-point, qx,qy,qz
    -0.2500000 -0.2500000  0.7500000  24.00  !
    -0.5000000 -0.5000000  1.0000000  12.00  !
     0.0000000  0.0000000  1.0000000   3.00  !
    -0.5000000  0.0000000  1.0000000   6.00  ! the last q-point
elph_dir/elph.inp_lambda.1 ! elph output file names,
elph_dir/elph.inp_lambda.2 ! in the same order as the q-points before
elph_dir/elph.inp_lambda.3
elph_dir/elph.inp_lambda.4
elph_dir/elph.inp_lambda.5
elph_dir/elph.inp_lambda.6
elph_dir/elph.inp_lambda.7
elph_dir/elph.inp_lambda.8
0.10                     ! \mu the Coloumb coefficient in the modified
                         ! Allen-Dynes formula for T_c (via \omega_log)

```

#### 4.3.2 使用EPW模块计算电子-声子耦合系数


## 5. 杂化泛函和Wannier函数

HSE06是一种杂化泛函（Hybrid functional），其中交换作用短程部分用GGA和Hatree-Fock的混合，长程部分使用GGA，关联则统一使用GGA。HSE06相对于GGA计算结果，总能和力的准确度有系统性的提升[12]，但是计算量很大。Wannier基函数是与平面波基函数可以相互变换的完备基，是一种局域轨道基函数[13]。QE中的wannier模块可以提取k点网格上的平面波波函数结果，得到最局域万尼尔函数MLWF，并使用MLWF快速计算出更多k点的能级。

计算前需要编译wannier90模块，QE目录运行```make w90```。这里参考安装包中的例子q-e-qe-6.3/PW/examples/EXX_example以及q-e-qe-6.3/W90/examples/example03和example05。

计算HSE能带有以下四步：
1. 用pw.x运行‘scf’。
2. 运行wannier90.x -pp (预处理pre-process，或在输入文件内写postproc_setup = .true.)生成seedname.nnkp。
3. 运行pw2wannier90.x读入pw输出文件、seedname.pw2wan和seedname.nnkp, 生成seedname.mmn, seedname.amn和seedname.eig。
4. 运行wannier90.x得到能带。

### 5.1 杂化泛函自洽计算

用HSE06进行scf计算，运行pw.x，输入如下，这里采用了pslibrary1.0的超软赝势，采用了PBE的晶格常数（见第1.4节），也可以用HSE06做vc-relax或状态方程计算，计算需要关掉对称性，得到完整的k网格（4×4×4=64个k点）：
```
&CONTROL
    calculation='scf', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5
/
&SYSTEM
    ibrav= 0,
    nat= 2, ntyp= 2,
    occupations = 'smearing', smearing = 'gauss', degauss = 1.0d-9
    ecutwfc= 50, ecutrho = 500,
    input_dft='hse'
    exxdiv_treatment = 'gygi-baldereschi'
    ecutvcut = 0.7
    x_gamma_extrapolation = .true.
    nqx1=4, nqx2=4, nqx3=4,
nosym=.true.
nosym_evc=.true.
noinv=.true.
/
&ELECTRONS
    electron_maxstep = 100
    conv_thr = 1.0d-9
    mixing_mode = 'plain'
    mixing_beta = 0.8d0
    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
    press_conv_thr=0.1
/
ATOMIC_SPECIES
  Si 28.08550 Si.UPF
  C  12.01070 C.UPF
ATOMIC_POSITIONS (crystal)
Si       0.000000000   0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
K_POINTS {automatic}
  4 4 4 0 0 0 
CELL_PARAMETERS (angstrom)
   2.188890473   2.188890473   0.000000000
   0.000000000   2.188890473   2.188890473
   2.188890473   0.000000000   2.188890473
```

### 5.2 提取Wannier函数并计算能带

输入文件sc.win如下，其中```mp_grid      = 4 4 4```要与HSE06的scf计算中k点一致，```kpoints```采用pw输出的k点（分数坐标，见wannier90 user_guide 2.4.6节），运行```wannier90.x -pp sc```：

```
num_bands         =   8      
num_wann          =   8

dis_win_max       = 17.0d0
dis_froz_max      =  6.4d0
dis_num_iter      =  120
dis_mix_ratio     = 1.d0

num_iter          = 50
num_print_cycles  = 10

Begin Atoms_Frac
Si       0.000000000   0.000000000   0.000000000
C        0.250000000   0.250000000   0.250000000
End Atoms_Frac
    
Begin Projections     
Si : sp3 
C  : sp3 
End Projections       
    
begin kpoint_path
L 0.50000  0.50000 0.5000 G 0.00000  0.00000 0.0000
G 0.00000  0.00000 0.0000 X 0.50000  0.00000 0.5000
X 0.50000 -0.50000 0.0000 K 0.37500 -0.37500 0.0000 
K 0.37500 -0.37500 0.0000 G 0.00000  0.00000 0.0000
end kpoint_path

!bands_plot = .true.

Begin Unit_Cell_Cart
   2.188890473   2.188890473   0.000000000
   0.000000000   2.188890473   2.188890473
   2.188890473   0.000000000   2.188890473
End Unit_Cell_Cart

mp_grid      = 4 4 4

begin kpoints
 0.0000000   0.0000000   0.0000000
 0.0000000   0.0000000   0.2500000
 0.0000000   0.0000000  -0.5000000
 0.0000000   0.0000000  -0.2500000
 0.0000000   0.2500000   0.0000000
 0.0000000   0.2500000   0.2500000
 0.0000000   0.2500000  -0.5000000
 0.0000000   0.2500000  -0.2500000
 0.0000000  -0.5000000   0.0000000
 0.0000000  -0.5000000   0.2500000
 0.0000000  -0.5000000  -0.5000000
 0.0000000  -0.5000000  -0.2500000
 0.0000000  -0.2500000   0.0000000
 0.0000000  -0.2500000   0.2500000
 0.0000000  -0.2500000  -0.5000000
 0.0000000  -0.2500000  -0.2500000
 0.2500000   0.0000000   0.0000000
 0.2500000   0.0000000   0.2500000
 0.2500000   0.0000000  -0.5000000
 0.2500000   0.0000000  -0.2500000
 0.2500000   0.2500000   0.0000000
 0.2500000   0.2500000   0.2500000
 0.2500000   0.2500000  -0.5000000
 0.2500000   0.2500000  -0.2500000
 0.2500000  -0.5000000   0.0000000
 0.2500000  -0.5000000   0.2500000
 0.2500000  -0.5000000  -0.5000000
 0.2500000  -0.5000000  -0.2500000
 0.2500000  -0.2500000   0.0000000
 0.2500000  -0.2500000   0.2500000
 0.2500000  -0.2500000  -0.5000000
 0.2500000  -0.2500000  -0.2500000
-0.5000000   0.0000000   0.0000000
-0.5000000   0.0000000   0.2500000
-0.5000000   0.0000000  -0.5000000
-0.5000000   0.0000000  -0.2500000
-0.5000000   0.2500000   0.0000000
-0.5000000   0.2500000   0.2500000
-0.5000000   0.2500000  -0.5000000
-0.5000000   0.2500000  -0.2500000
-0.5000000  -0.5000000   0.0000000
-0.5000000  -0.5000000   0.2500000
-0.5000000  -0.5000000  -0.5000000
-0.5000000  -0.5000000  -0.2500000
-0.5000000  -0.2500000   0.0000000
-0.5000000  -0.2500000   0.2500000
-0.5000000  -0.2500000  -0.5000000
-0.5000000  -0.2500000  -0.2500000
-0.2500000   0.0000000   0.0000000
-0.2500000   0.0000000   0.2500000
-0.2500000   0.0000000  -0.5000000
-0.2500000   0.0000000  -0.2500000
-0.2500000   0.2500000   0.0000000
-0.2500000   0.2500000   0.2500000
-0.2500000   0.2500000  -0.5000000
-0.2500000   0.2500000  -0.2500000
-0.2500000  -0.5000000   0.0000000
-0.2500000  -0.5000000   0.2500000
-0.2500000  -0.5000000  -0.5000000
-0.2500000  -0.5000000  -0.2500000
-0.2500000  -0.2500000   0.0000000
-0.2500000  -0.2500000   0.2500000
-0.2500000  -0.2500000  -0.5000000
-0.2500000  -0.2500000  -0.2500000
End Kpoints
```

以下文件保存为pw2wan.inp，运行```pw2wannier90.x < pw2wan.inp > pw2wan.out```：

```
&inputpp
   outdir = './tmp'
   prefix = 'pwscf'
   seedname = 'sc'
   spin_component = 'none'
   write_mmn = .true.
   write_amn = .true.
   write_unk = .true.
/
```

将sc.win中的```!bands_plot = .true.```注释叹号删去，再运行一次```wannier90.x sc```，得到wannier基函数的能带值sc_band.dat，用这个文件画图，gnuplot输入文件如下：

```
reset
set terminal pngcairo size 580,880 enhanced font 'Times-Roman,15'
set output "out.png"

set style data dots
set nokey

set label "SiC HSE06   Eg=2.15eV" at graph 0.05,graph 0.96

set xrange [0: 4.70794]
!set yrange [ -20.0 : 20.0]
set yrange [ -20 : 20]
set arrow from  1.24296,  -20.0 to  1.24296,  20.0 nohead
set arrow from  2.67820,  -20.0 to  2.67820,  20.0 nohead
set arrow from  3.18564,  -20.0 to  3.18564,  20.0 nohead
set xtics ("L"  0.00000,"{/Symbol G}"  1.24296,"X"  2.67820,"K"  3.18564,"{/Symbol G}"  4.70794)
 plot "sc_band.dat" using 1:($2-0.88318010E+01) with lines lt 1  lw 2 lc rgb "red"
```

结果如下图，带隙值与PBE（见1.4节）相比有所提升。

注：这里作为示例取k点偏小了，实际计算建议k点增加到6×6×6，wannier拟合效果好一些；HSE自洽scf可以不关对称性用较少的k点，接着做一次scf的完整k网格计算，读取电荷，可以减小部分计算量（QE不支持HSE-nscf）；wannier只能选取部分价带导带拟合，含有半芯态的赝势，需要用exclude_bands排除较低的半芯态和较高的能带；Projections一般根据价态电子选择，见wannier手册第三章，不限于原子成键电子的spd类型，有一定的任意性，对于同一种材料可能会有不同的选择，但是有些选择得到的能带和scf计算得到的更接近；可以将wannier中心设置在其他位置，如键中心等；num_wann等于Projections设置的总的轨道数；num_bands等于或大于num_wann，num_bands加上exclude_bands个数等于scf计算中的nbnd，一个wannier轨道形成一条带，num_bands大于num_wann时，多出来的带默认会disentangle，设置dis_win_min和dis_win_max作为能量窗口。

<p align="left">
    <img src="../../../../../img/sc_hseband.png" width="580"/>
</p>

## 6. 波函数投影

QE计算的波函数是以平面波基组表示的，而原子轨道有更好的直观性和可解释性，是分析能带不可或缺的手段，可以将各个k点的各个能级的波函数，投影到以各个原子坐标为中心的s、p、d、f等球谐函数上（以及非共线和磁性计算中的自旋），即为（local）projected density of states，用projwfc.x模块计算，下面以$SnO_{2}$(rutile)的投影态密度为例。

### 6.1 投影态密度

做vc-relax，输入文件如下：

```Fortran
&CONTROL
    calculation='vc-relax', disk_io='low', prefix='pwscf',
    pseudo_dir='./', outdir='./tmp', verbosity='high'
    tprnfor=.true., tstress=.true., forc_conv_thr=1.0d-5, etot_conv_thr=1.0d-5, nstep=100,
/
&SYSTEM
    ibrav= 6,
    celldm(1)=8.952142,
    celldm(3)=0.672620,
    nat= 6,
    ntyp= 2,
    occupations = 'fixed', nbnd=32,
    ecutwfc= 50, ecutrho = 600,
/
&ELECTRONS
    electron_maxstep = 100,    conv_thr = 1.0d-9,    mixing_mode = 'plain'
    mixing_beta = 0.7d0,    diagonalization = 'david'
/
&IONS
    ion_dynamics='bfgs'
/
&CELL
   press = 0.00 ,
   press_conv_thr=0.1
   cell_dynamics = 'bfgs' ,
/
ATOMIC_SPECIES
  Sn 118.710  Sn.pbe-dn-rrkjus_psl.1.0.0.UPF
  O   15.999  O.pbe-n-rrkjus_psl.1.0.0.UPF
ATOMIC_POSITIONS (crystal)
Sn  0.000000   0.000000   0.000000
Sn  0.500000   0.500000   0.500000
O   0.307000   0.307000   0.000000
O  -0.307000  -0.307000   0.000000
O   0.193000   0.807000   0.500000
O   0.807000   0.193000   0.500000
K_POINTS {automatic}
  6 6 9 0 0 0
```

计算DOS需要较密的k点，再做一次nscf计算，k点设置为

```
K_POINTS {automatic}
  13 13 20 0 0 0
```

以下文件保存为proj.inp，运行```mpirun projwfc.x <proj.inp >proj.out```。

```Fortran
&PROJWFC
prefix='pwscf',
outdir='./tmp',
ngauss=0,
degauss=0.01,
DeltaE=0.005
lsym=.true.
filpdos='sno',
filproj='sno',
/
```

用以下Python程序画图：

```
#!/bin/env python
# -*- coding: utf-8 -*-
"""
@author: yyyu200@163.com
"""

import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt
import numpy as np

lw=1.2

F=plt.gcf()
F.clf()
p=plt.subplot(1, 1, 1)

# change by-hand here, read scf input in the future
elem=['Sn','O']
ielem=np.array([2,4],dtype=np.int32) # number of atoms for each element
orb=[['s','p','d'],['s','p']]  # projectors for each element
iorb=np.array([3,2],dtype=np.int32) # number of projectors for each element

num_file=np.dot(ielem,iorb)
nat=np.sum(ielem)
D=[]
N=len(elem)

#scf ATOMIC_POSITIONS should be sorted in the same order as above
count=0
count_at=0
for n in range(N):
    for i in range(ielem[n]):
        for j in range(iorb[n]):
            print(n,i,j,count_at+1,elem[n],j+1,orb[n][j])
            fname='sno.pdos_atm#{}({})_wfc#{}({})'.format(count_at+1,elem[n],j+1,orb[n][j])
            D.append(np.loadtxt(fname,dtype=np.float32))
            count+=1
        count_at+=1

e_fermi=8.7233
line1=plt.plot(D[0][:,0]-e_fermi,D[0][:,1]+D[3][:,1],color='g',linewidth=lw,label='Sn s' )
line2=plt.plot(D[0][:,0]-e_fermi,D[1][:,1]+D[4][:,1],color='r',linewidth=lw,label='Sn p' )
line3=plt.plot(D[0][:,0]-e_fermi,D[2][:,1]+D[5][:,1],color='b',linewidth=lw,label='Sn d' )

line4=plt.plot(D[0][:,0]-e_fermi,D[6][:,1]+D[8][:,1]+D[10][:,1]+D[12][:,1],color='cyan',linewidth=lw,label='O s' )
line5=plt.plot(D[0][:,0]-e_fermi,D[7][:,1]+D[9][:,1]+D[11][:,1]+D[13][:,1],color='grey',linewidth=lw,label='O p' )
plt.xlim([-10,7])
plt.ylim([0,10.5])

plt.ylabel(r'DOS (a.u.)',fontsize=16)
plt.xlabel(r'E (eV) ',fontsize=16)
plt.legend()
plt.savefig('pdos.png',dpi=200)
```

结果如图所示。
<p align="left">
    <img src="../../../../../img/sno_pdos.png" width="1000"/>
</p>

### 6.2 投影能带
进行一次能带计算，输入中修改`calculation='bands'`，k点设置为：
```
K_POINTS {crystal_b}
3
M 30
gG 30
Z 0
```
依次运行pw.x、projwfc.x，在能带计算之后，用projwfc.x生成的[sno.projwfc_up文件](../../../../../img/snoproj.tar.gz)，可以和bands.x（输入见1.4节）生成的文件bd.dat结合画出各个能带的原子轨道投影，画图脚本如下：

```
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
@author: yyyu200@163.com
"""

import numpy as np

# plot range for y-axis
ymin=-23
ymax=10
dline=30 # vertical line intervals
lw=0.5 # line width
nband=26 # highest valence band

feig=open('bd.dat')
l=feig.readline()
nbnd=int(l.split(',')[0].split('=')[1])
nks=int(l.split(',')[1].split('=')[1].split('/')[0])

eig=np.zeros((nks,nbnd),dtype=float)
for i in range(nks):
    l=feig.readline()
    count=0
    if nbnd%10==0:
        n=nbnd//10
    else:
        n=nbnd//10+1
    for j in range(n):
        l=feig.readline()
        for k in range(len(l.split())):
            eig[i][count]=l.split()[k]
            count=count+1

feig.close()

import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt

F=plt.gcf()
F.set_size_inches([4,5])
p1=plt.subplot(1, 1, 1)

eig_vbm=max(eig[:, nband-1])
#eig_vbm= 0.00 # fermi energy level in scf output for metals
for i in range(nbnd):
    line1=plt.plot(np.arange(0,nks), eig[:,i]-eig_vbm,color='grey',linewidth=lw )

vline=dline
while vline<nks-1:
    plt.axvline(x=vline, ymin=ymin, ymax=ymax,linewidth=lw,color='black')
    vline=vline+dline

elem=['Sn','O']
ielem=np.array([2,4],dtype=np.int32) # number of atoms for each element
orb=[['s','p','d'],['s','p']]  # projectors for each element

N=len(elem)
iorb=np.zeros([N,],dtype=np.int32)  # number of projectors for each element
for i in range(N):
    iorb[i]=len(orb[i])

lorb=np.zeros([N,],dtype=np.int32) # number of local orbital for each element
for i in range(N):
    for j in orb[i]:
        if j is 's':
            lorb[i]+=1
        elif j is 'p':
            lorb[i]+=3
        elif j is 'd':
            lorb[i]+=5
        elif j is 'f':
            lorb[i]+=7
        else:
            print("unexpect: ",j)
            assert False

nlorb=np.dot(ielem,lorb)

pjsum=np.zeros([nlorb, nks, nbnd], dtype=np.float32)

filproj=open('sno.projwfc_up')
nline_io_header=14 # line number at '    F    F'

for i in range(nline_io_header):
    filproj.readline()

for i in range(nlorb):
    filproj.readline()
    for j in range(nks):
        for k in range(nbnd):
            pjsum[i,j,k]=float(filproj.readline().split()[2])

nplotline=np.sum(iorb)
# oo, orbital index for each kind of color, oo can be generated by the following commands
#grep '[a-zA-Z]' sno.projwfc_up |grep 2P|awk '{printf( $1-1",")}'
oo=[[0,9],
[1,2,3,10,11,12],
[4,5,6,7,8,13,14,15,16,17],
[18,22,26,30],
[19,20,21,23,24,25,27,28,29,31,32,33]]

s_of_o=np.zeros([nks,],dtype=np.float32)
color=['r','g','orange','cyan','blue']
label=['Sn s','Sn p','Sn d','O s','O p']

scale=90.0
st=[]
for i in range(len(oo)):
    for k in range(nbnd):
        s_of_o=np.zeros([nks,],dtype=np.float32)
        for j in oo[i]:
            s_of_o[:]+=pjsum[j,:,k]
        if k == 0:
            st.append(plt.scatter(-1, ymin-1, 20, c=color[i], alpha=0.5, label=label[i],marker='.',edgecolor='none'))
        st.append(plt.scatter(np.arange(0,nks), eig[:,k]-eig_vbm, s=scale*s_of_o, c=color[i], alpha=0.5, marker='.',edgecolor='none'))

plt.xlim([0,nks-1]) # 201 points
plt.ylim([ymin,ymax])
plt.ylabel(r'E (eV)',fontsize=16)
plt.xticks((0,30,60), ('M', r'${\Gamma}$', 'Z') )

plt.subplots_adjust(left=0.20, right=0.75, top=0.95, bottom=0.1)
p1.legend(scatterpoints =1, numpoints=1,markerscale=2.0, bbox_to_anchor=(1.05, 1), loc='upper left', borderaxespad=0.)

plt.savefig('pjband.png',dpi=400)
```
结果如图所示。
<p align="left">
    <img src="../../../../../img/sno_pjband.png" width="1000"/>
</p>

另外在PP目录下有sumpdos.x和plotproj.x两个工具。

## 7. 自旋

本节只在计算需要考虑相应特性的材料时加入，默认不加。

### 7.1 自旋轨道耦合 

计算基于Dirac方程的二分量近似（Foldy-Wouthuysen transformation）。

在输入中加入```noncolin=.true., lspinorb=.true.,```。

使用至少一种元素的full relativistic赝势。

不支持relax计算（QE未实现）。

Spin-orbit只对较重元素具有明显的效应。参考标准从第5周期开始加入自旋轨道耦合。

### 7.2 自旋极化

基于局域自旋密度近似（LSDA）。

输入中加入```nspin = 2```。设置至少一种元素的starting_magnetization(i), i=1...ntyp值非零，scf计算中磁矩从此值逐渐减小直到收敛（只减不增，通常设为1）。

自旋极化不必要full relativistic赝势（见7.3节），支持relax计算。

#### 7.2.1 同种元素不同磁矩的设置

例：反铁磁NiO。

```
&control
  calculation='scf', disk_io='low', prefix='pwscf',
  pseudo_dir='./', outdir='./tmp', verbosity='high'
/
&system
  ibrav= 0, celldm(1)=7.93, nat= 4, ntyp= 3,
  ecutwfc = 50.0, ecutrho = 500.0,
  occupations='smearing', smearing='mv', degauss=0.02,
  nspin=2,
  starting_magnetization(2)= 0.5,
  starting_magnetization(3)=-0.5,
/
&electrons
  conv_thr = 1.0d-9
  mixing_beta = 0.8d0
  diagonalization = 'david'
/
CELL_PARAMETERS (alat)
  0.50 0.50 1.00
  0.50 1.00 0.50
  1.00 0.50 0.50
ATOMIC_SPECIES
    O 16.00  O.UPF
  Ni1 58.69 Ni.UPF
  Ni2 58.69 Ni.UPF
ATOMIC_POSITIONS (crystal)
   O 0.25 0.25 0.25
   O 0.75 0.75 0.75
 Ni1 0.00 0.00 0.00
 Ni2 0.50 0.50 0.50
K_POINTS (automatic)
  6 6 6 0 0 0
```

计算输出的结尾可以找到：
```
     total magnetization       =     0.00 Bohr mag/cell
     absolute magnetization    =     2.87 Bohr mag/cell
```
总磁矩是0.00，与反铁磁符合（此材料需要LDA+U或Hybrid functional以得到带隙）。

### 7.3 非共线磁性

同时加入了自旋极化和非共线自旋。

在输入中加入```noncolin=.true., lspinorb=.true.,```。设置至少一种元素的starting_magnetization(i)值非零, i=1...ntyp。设置angle1(i),angle2(i)。使用至少一种full relativistic赝势。

## References

1. https://avogadro.cc/docs/building-materials/reducing-crystals-to-primitive-cells/

2. https://www.researchgate.net/post/How_to_convert_a_conventional_cell_to_a_primitive_cell 

3. Bilbao, http://www.cryst.ehu.es/cryst/celltran.html

4. Wahyu Setyawan, Stefano Curtarolo, *High-throughput electronic band structure calculations: Challenges and tools*. Computational Materials Science 49 (2010) 299–312.(doi:[10.1016/j.commatsci.2010.05.010](https://www.sciencedirect.com/science/article/pii/S0927025610002697)).

5. http://www.ioffe.ru/SVA/NSM/Semicond/SiC/bandstr.html

6. Sgiarovello, C., Binggeli, N., Baldereschi, A. (2004). *Surface morphology and ionization potentials of polar semiconductors: The case of GaAs*. Physical Review B, 69(3). doi:[10.1103/PhysRevB.69.035320](http://dx.doi.org/10.1103/PhysRevB.69.035320).

7. F. Bassani, G. Parravicini, *Electronic states and optical transitions in solids*. Pergamon Press (1975).

8. Anna Tararan et al. *Optical gap and optically active intragap defects in cubic BN*. [Phys. Rev. B 98, 094106 (2018).](http://dx.doi.org/10.1103/PhysRevB.98.094106)

9. Martin Dressel, George Gruner, *Electrodynamics of Solids-Optical Properties of Electrons in Matter*. Cambridge University Press (2002).

10. P. Giannozzi et al, *Ab initio calculation of phonon dispersions in semiconductors.* [Phys. Rev. B **43**, 7231 (1991).](http://dx.doi.org/10.1103/PhysRevB.43.7231). L. Lindsay et al, *Ab initio thermal transport in compound semiconductors.* [Physical Review B **87**,165201 (2013)](http://dx.doi.org/10.1103/PhysRevB.87.165201).

11. P.Y. Yu, M. Cardona, *Fundamentals of Semiconductors: Physics and Materials Properties*, Springer, 2010.

12. J. Paier et al, *Screened hybrid density functionals applied to solids*, The Journal of Chemical Physics 124, 154709 (2006); doi: [10.1063/1.2187006](http://dx.doi.org/10.1063/1.2187006).

13. Marzari et al, *Maximally localized Wannier functions: Theory and applications*, [Rev. Mod. Phys. **84**, 1419 (2012)](https://link.aps.org/doi/10.1103/RevModPhys.84.1419).


Update On 2019/09/05

Update On 2020/01/22

<span id="busuanzi_container_page_pv">本文总阅读量<span id="busuanzi_value_page_pv"></span>次


